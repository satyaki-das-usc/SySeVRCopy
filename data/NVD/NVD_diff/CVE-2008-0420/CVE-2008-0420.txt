--- modules/libpr0n/decoders/bmp/nsBMPDecoder.cpp	9 Nov 2007 12:47:50 -0000	1.37
+++ modules/libpr0n/decoders/bmp/nsBMPDecoder.cpp	13 Dec 2007 09:52:46 -0000
@@ -233,19 +233,23 @@ NS_METHOD nsBMPDecoder::ProcessData(cons
             mBIH.bpp != 16 && mBIH.bpp != 24 && mBIH.bpp != 32)
           return NS_ERROR_UNEXPECTED;
 
         if (mBIH.bpp <= 8) {
             mNumColors = 1 << mBIH.bpp;
             if (mBIH.colors && mBIH.colors < mNumColors)
                 mNumColors = mBIH.colors;
 
-            mColors = new colorTable[mNumColors];
+            // Always allocate 256 even though mNumColors might be smaller,
+            // to avoid having to check bounds in SetPixel
+            mColors = new colorTable[256];
             if (!mColors)
                 return NS_ERROR_OUT_OF_MEMORY;
+
+            memset(mColors, 0, 256 * sizeof(colorTable));
         }
         else if (mBIH.compression != BI_BITFIELDS && mBIH.bpp == 16) {
             // Use default 5-5-5 format
             mBitFields.red   = 0x7C00;
             mBitFields.green = 0x03E0;
             mBitFields.blue  = 0x001F;
             CalcBitShift();
         }
